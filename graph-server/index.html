<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notion Graph Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body{
      font-family:Arial, Helvetica, sans-serif;
    }
    h1{
      font-size: 16px;
    }
    .node {
      fill:#fff;
    }

    .link {
      stroke: #c1c1c1;
      stroke-opacity: 0.6;
    }
    .label{
      fill:white;
    }
  </style>
</head>
<body>
  <h1>Notion Graph Visualization</h1>
  <div id="graph"></div>

  <script>
    const blockId = '9a1db0177fac4402bdb3bc881aa6d0ad'; // Substitua pelo ID inicial do bloco

    async function fetchGraphData(blockId) {
        try{
          const response = await fetch(`http://localhost:3000/mock`);
          const data= response.json();
          localStorage.setItem("graph-notion", JSON.stringify(data))
          return data
        } catch(e){
            console.error(e)
        }
    }

    async function renderGraph() {
      const data = await fetchGraphData(blockId)

      const nodes = data.filter(d => d.type === 'page').map(d => ({ id: d.id, label: d.label }));
      const links = data.filter(d => d.type === 'node' && 
        nodes.some(node => node.id === d.source) && 
        nodes.some(node => node.id === d.target))
        .map(d => ({ source: d.source, target: d.target }));
      const width = window.innerWidth;
      const height = window.innerHeight - 50;


 // Criar o SVG onde o grafo será desenhado
 const svg = d3.select("#graph")
 .append("svg")
 .attr("width", window.innerWidth)
 .attr("height", window.innerHeight - 50);

// Configurar a simulação de força
const simulation = d3.forceSimulation(nodes)
 .force("link", d3.forceLink(links).id(d => d.id).distance(data.length/4))
 .force("charge", d3.forceManyBody().strength(-(data.length / 3)))
 .force("center", d3.forceCenter(width / 2, height / 2));

// Desenhar as linhas dos links
const link = svg.append("g")
 .attr("class", "links")
 .selectAll("line")
 .data(links)
 .enter()
 .append("line")
 .attr("class", "link");

// Desenhar os nós como círculos
// Adicionar nós com <a> ao redor
const node = svg.append("g")
  .attr("class", "nodes")
  .selectAll("a")
  .data(nodes)
  .enter()
  .append("a")
  .attr("xlink:href", d => `https://notion.so/eroshi/${d.id.replaceAll("-","")}`) // Substitua pela sua URL
  .attr("target", "_blank") // Abre o link em uma nova aba
  .append("circle")
  .attr("class", "node")
  .attr("r", 5)
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended));
// Adicionar rótulos de texto aos nós
const labels = svg.append("g")
 .attr("class", "labels")
 .selectAll("text")
 .data(nodes)
 .enter()
 .append("text")
 .attr("class", "label")
 .attr("text-anchor", "middle")
 .attr("dy", -15) // Posiciona o texto acima do nó
 .text(d => d.label);

  // Função de atualização chamada a cada tick da simulação
  simulation.on("tick", () => {
    link
      .attr("x1", d => d.source.x)
      .attr("y1", d => d.source.y)
      .attr("x2", d => d.target.x)
      .attr("y2", d => d.target.y);

    node
      .attr("cx", d => d.x = Math.max(10, Math.min(width -10, d.x))) // Limita a posição em X
      .attr("cy", d => d.y = Math.max(10, Math.min(height -10, d.y))); // Limita a posição em Y

    labels
      .attr("x", d => d.x)
      .attr("y", d => d.y);
  });

    // Funções de arrastar os nós
    function dragstarted(event, d) {
    if (!event.active) simulation.alphaTarget(0.2).restart();
    d.fx = d.x;
    d.fy = d.y;
    }

    function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
    }

    function dragended(event, d) {
    if (!event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
    }
}


    renderGraph();
  </script>
</body>
</html>
